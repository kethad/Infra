#This CFT will deploy RDS DB for Kenstar in AWS lower environment. 
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  Environment:
    Type: String
    Description: Environment Name (DEV/QA/BETA)
    AllowedValues: ['DEV', 'QA', 'dev', 'qa','BETA','beta']
  Database:
    Type: String
    Default: 'CARE'
    Description: Database Name  
  AppID:
    Type: String
    Default: '1478EE8A-20BC-4174-BACD-35D9E61A3F73' 
    Description: AppID
  BU: 
    Type: String
    Default: 'DJI'
    Description: BU Name 
  SupportGroup:
    Type: String
    Default: 'IM-SPDJI-Index infrastructure'
    Description: SupportGroup Name
  DBUsername:
    NoEcho: 'true'
    Description: Username for Oracle database access
    Type: String
    Default: 'rdsmstr'
    MinLength: '1'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: 'true'
    Description: Password Oracle database access
    Type: String
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: '^[a-zA-Z]+[0-9a-zA-Z_]*$'
    ConstraintDescription: Must start with a letter. Only numbers, letters, and _ accepted. max length 16 characters
  #DBAllocatedStorage:
  #  Default: '300'
  #  Description: The size of the database (GiB)
  #  Type: Number
  #  MinValue: '500'
  #  MaxValue: '1000'
  #  ConstraintDescription: must be between 20 and 65536 GiB. 
  AllowMajorVersionUpgrade:
    Description: If you update the EngineVersion property to a version that is different from the DB instances current major version, set this property to true.
    Type: String
    AllowedValues: [true, false]
    ConstraintDescription: "Value must be boolean value."
    Default: false
  AutoMinorVersionUpgrade:
    Description: Indicates that minor engine upgrades are applied automatically to the DB instance during the maintenance window. The default value is true.
    Type: String
    AllowedValues: [true, false]
    Default: true
    ConstraintDescription: "Value must be boolean value."
  BackupRetentionPeriod:
   Description: The number of days during which automatic DB snapshots are retained.
   Type: String
   AllowedPattern: "^[0-9]{1,3}$"
   ConstraintDescription: "Value must be a valid number between 0-999."
   Default: 3  ##was 5
  DBInstanceClass:
    Description: The name of the compute and memory capacity classes of the DB instance.
    Type: String
    Default: db.m5.2xlarge
    AllowedValues: [db.m5.large,db.m5.xlarge,db.m5.2xlarge,db.m5.4xlarge,db.m5.8xlarge,db.m5.12xlarge,db.m5.16xlarge,db.m5.24xlarge,db.r5.2xlarge] 
    
  Engine:
    Description: The name of the database engine to be used for this instance.
    Type: String
    Default: oracle-ee
    AllowedValues: [mysql, mariadb, postgres,oracle-ee]
    ConstraintDescription: "Please specify either a mysql, mariadb, or postgres engine for the RDS instance."
  DBCACertificateIdentifier:
    Description: The name of the CA Certificate to use with the DB instance.
    Type: String
    Default: rds-ca-rsa2048-g1
    AllowedValues: [rds-ca-rsa2048-g1,rds-ca-rsa4096-g1,rds-ca-ecc384-g1,rds-ca-2019]
  #MultiAZ:
  #  Description: Specifies if the database instance is a multiple Availability Zone deployment.
  #  Type: String
  #  AllowedValues: [true, false]
  #  Default: false
  #  ConstraintDescription: "Value must be boolean value."  
  PreferredMaintenanceWindow:
    Description: Maintenance Window.
    Type: String
    #Default: fri:03:00-fri:04:00
    Default: sat:04:01-sat:08:00
  DeletionProtection:
    Description: A value that indicates whether the DB cluster has deletion protection enabled. The database can be deleted when deletion protection is enabled. By default, deletion protection is disabled.
    Type: String
    Default: no
  PreferredBackupWindow:
    Description: Backup Window.
    Type: String
    Default: 03:00-04:00
  EngineVersion:
    Description: The version number of the database engine to use.
    Type: String
    Default: 19.0.0.0.ru-2022-01.rur-2022-01.r1
    AllowedValues: [19.0.0.0.ru-2021-01.rur-2021-01.r1,19.0.0.0.ru-2021-01.rur-2021-01.r2,19.0.0.0.ru-2022-01.rur-2022-01.r1]
  DBInstanceIdentifier:
    Description: A name for the DB instance.
    Type: String
  StorageType:
    Type: String
    Default: gp2
    AllowedValues: [gp2, io1]
  MaxAllocatedStorage:
    Type: String
    Default: 2000
    Description: The upper limit to which Amazon RDS can automatically scale the storage of the DB instance.  
  CharacterSetName:
    Type: String
    Default: AL32UTF8
    Description: For supported engines, indicates that the DB instance should be associated with the specified character set.


Mappings:
  DBSubnetGroup:
    DEV:
      DBSubnetGroupName: dev-rds-new-private-subnet-group
    QA:
      DBSubnetGroupName: qa-rds-new-private-subnet-group
    BETA:
      DBSubnetGroupName: uat-rds-new-private-subnet-group

  VPCSecurityGroups:
    DEV:
      SGID: [sg-03dec67f]
    QA:
      SGID: [sg-a5da35d4]
    BETA:
      SGID: [sg-0f2e7da38ebb2acbc]      ##SGID: [sg-8b5553fd] before
  KeyNames:
    DEV:
      Name: 'alias/rds-nonprod-kms-key' 
    QA:
      Name: 'alias/QA-RDS' 
    BETA:
      Name: 'alias/UAT-RDS'
  DBParameterGroupName:
    DEV: 
      Name: dev-care-param-oracle
    QA:
      Name: qa-care-param-oracle
    BETA:
      Name: beta-care-param-oracle 
  OptionGroupName:
    DEV:
      #Name: dev-care-option-oracle
      Name: dev-care-option-oracle-2
    QA:
      #Name: qa-care-option-oracle
      Name: qa-care-option-oracle-2
    BETA:
      #Name: beta-care-option-oracle
      Name: beta-care-option-oracle3     ## was beta-care-option-oracle-2
  DBAllocatedStorage:
    DEV:
      Storage: 1000
    QA:
      Storage: 1000
    BETA:
      Storage: 1000
  DBName:
    DEV:
      Name: cared
    QA:
      Name: careq
    BETA:
      Name: careb
  MultiAZ:
    DEV:
      Name: false
    QA:
      Name: false
    BETA:
      Name: true

Resources:
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: !FindInMap
        - DBAllocatedStorage
        - !Ref Environment
        - Storage
      AllowMajorVersionUpgrade: !Ref AllowMajorVersionUpgrade
      AutoMinorVersionUpgrade: !Ref AutoMinorVersionUpgrade
      BackupRetentionPeriod: !Ref BackupRetentionPeriod
      DBInstanceClass: !Ref DBInstanceClass
      CACertificateIdentifier: !Ref DBCACertificateIdentifier
      DBName: !FindInMap
        - DBName
        - !Ref Environment
        - Name
      Engine: !Ref Engine
      EngineVersion: !Ref EngineVersion
      LicenseModel: bring-your-own-license
      DBSubnetGroupName: !FindInMap
        - DBSubnetGroup
        - !Ref Environment
        - DBSubnetGroupName
      VPCSecurityGroups: !FindInMap
        - VPCSecurityGroups
        - !Ref Environment
        - SGID

      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow
      PreferredBackupWindow: !Ref PreferredBackupWindow
      MultiAZ: !FindInMap
        - MultiAZ
        - !Ref Environment
        - Name
      StorageEncrypted: Yes
      DeletionProtection: !Ref DeletionProtection
      CopyTagsToSnapshot: Yes
      DeleteAutomatedBackups: Yes
      PubliclyAccessible: No
      Port: '1521'
      StorageType: !Ref StorageType
      DBInstanceIdentifier: !Ref DBInstanceIdentifier
      #KmsKeyId: arn:aws:kms:us-east-1:699183880494:key/b0505725-3c0a-467a-8fdb-3d8f9ba574ad
      KmsKeyId: !FindInMap
        - KeyNames
        - !Ref Environment
        - Name
      DBParameterGroupName: !FindInMap
        - DBParameterGroupName
        - !Ref Environment
        - Name
      OptionGroupName: !FindInMap
        - OptionGroupName
        - !Ref Environment
        - Name
      MaxAllocatedStorage: !Ref MaxAllocatedStorage
      CharacterSetName: !Ref CharacterSetName
      EnableCloudwatchLogsExports:
        - 'audit'
        - 'listener'
        - 'alert'
        - 'trace'
      #EnablePerformanceInsights: !Ref EnablePerformanceInsights
      #PerformanceInsightsKMSKeyId: arn:aws:kms:us-east-1:699183880494:key/b0505725-3c0a-467a-8fdb-3d8f9ba574ad
      #PerformanceInsightsRetentionPeriod: !Ref PerformanceInsightsRetentionPeriod
      

      Tags:
      - Key: Name
        Value: !Sub ${Environment}-${Database}-${DBInstanceIdentifier}
      - Key: Owner
        Value: !Ref Database
      - Key: AppID
        Value: !Ref AppID
      - Key: BU
        Value: !Ref BU
      - Key: Environment
        Value: !Ref Environment
      - Key: SupportGroup
        Value: !Ref SupportGroup
      - Key: UsedFor
        Value: RDS   
Outputs:
  EndPoint: 
    Description: 'EndPoint for RDS DB'
    Value: !GetAtt 'RDSInstance.Endpoint.Address'
  InstanceName:
    Description:  'InstanceName of the newly created RDS Instance'
    Value: !Ref 'RDSInstance'        
